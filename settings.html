<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Surf Lime • Settings</title>

  <!-- ensure wrapper stays hidden until JS finishes boot -->
  <script>document.documentElement.setAttribute('data-boot','0')</script>

  <!-- Use Settings.png as the page art -->
  <link rel="prefetch" as="image" href="./Background/Settings.png">

  <script>
    // Prefetch a couple mascot frames so the game starts instantly after Play
    (function(){
      try{
        let n = localStorage.getItem('selectedMascotP1') || localStorage.getItem('selectedMascot') || 'Lime';
        if(n === 'Pinapple') n = 'Pineapple'; // historical typo guard
        const base = `./Mascots/${n}/${n}`;
        const urls = [`${base}Surfer.png`, `${base}Surf.png`, `${base}Fall.png`];
        for(const href of urls){
          const l = document.createElement('link');
          l.rel = 'prefetch'; l.as = 'image'; l.href = href;
          document.head.appendChild(l);
        }
      }catch(_){}
    })();
  </script>

  <style>
    /* ========== Theme (subtle, low-glow) ========== */
    :root{
      --sky:#0a3051; --sea:#0fb3c4; --reef:#18d3b2; --sand:#f8dba5;
      --ink:#fff; --muted:#cfe8f5; --line:#204a5a;
      --panel: rgba(9, 41, 73, .45); --panel-strong: rgba(6, 28, 54, .55);
      --focus:#ffe08a;
    }
    *{ box-sizing:border-box }
    html,body{
      margin:0; height:100%;
      color:var(--ink);
      font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        linear-gradient(to bottom, rgba(248,219,165,0) 65%, rgba(248,219,165,.6) 100%),
        linear-gradient(to bottom, var(--sky) 0%, #0d4a6d 28%, var(--sea) 60%, #12cfc9 75%);
      overflow-y:auto;
      -webkit-tap-highlight-color: transparent;
    }
    body::after{
      content:""; position:fixed; inset:0;
      background: url("./Background/Settings.png") bottom center / cover no-repeat;
      opacity:.20; pointer-events:none; z-index:0;
    }

    /* page boot reveal */
    html[data-boot="0"] .wrap{ opacity:0; transform:translateY(6px); }
    html[data-boot="1"] .wrap{ opacity:1; transform:none; transition:opacity .22s ease, transform .22s ease; }

    .wrap{ position:relative; z-index:1; max-width:1120px; margin:28px auto; padding:0 16px; }
    h1{ margin:0 0 6px; font-size:30px; letter-spacing:.2px; }

    /* ========== HERO ========== */
    .hero{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      min-height: clamp(180px, 26vh, 300px);
      margin: 10px 0 6px; text-align:center;
    }
    .cta-play{
      display:inline-flex; align-items:center; gap:10px;
      height:56px; padding:0 24px; border-radius:999px;
      font-weight:900; letter-spacing:.3px; text-decoration:none; color:#0b1320;
      background: linear-gradient(180deg,#ffd37e,#ff9851);
      border:1px solid #ffc27e;
      box-shadow: 0 6px 12px rgba(0,0,0,.18);
      transform: translateY(0);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .cta-play:hover{ filter:brightness(1.03) }
    .cta-play:active{ transform: translateY(0) scale(.99) }
    .cta-play:focus-visible{ outline:2px solid var(--focus); outline-offset:4px }
    .cta-icon{ display:inline-grid; place-items:center; width:26px; height:26px; border-radius:50%;
      background:#0b1320; color:#fff; font-size:16px; }
    .cta-hint{ margin-top:10px; font-size:12px; color:var(--muted); user-select:none; }

    /* ========== Top Bar (Two-Player switch) ========== */
    .bar{
      display:flex; justify-content:flex-end; align-items:center; gap:14px;
      margin:10px 0 18px; padding:10px 12px;
      border-radius:14px; border:1px solid #ffffff1f;
      background: linear-gradient(180deg, var(--panel), var(--panel-strong));
      backdrop-filter: blur(6px);
      box-shadow: 0 4px 10px rgba(0,0,0,.18), inset 0 0 0 1px #ffffff10;
    }
    .toggle{ display:flex; align-items:center; gap:10px; }
    .toggle .label{ font-weight:700 }

    /* modern switch */
    .switch{ position:relative; width:48px; height:28px; display:inline-block; }
    .switch input{ position:absolute; inset:0; opacity:0; }
    .slider{
      position:absolute; inset:0; border-radius:999px;
      background:#284a5a; border:1px solid #3a6477;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.25);
      transition: background .15s ease;
    }
    .slider::after{
      content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%;
      background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.25);
      transition: transform .15s ease;
    }
    .switch input:checked + .slider{ background:#1aa78d; border-color:#15947d; }
    .switch input:checked + .slider::after{ transform: translateX(20px); }
    .switch input:focus-visible + .slider{ outline:2px solid var(--focus); outline-offset:3px; }

    /* ========== Cards ========== */
    .info{
      margin:16px 0 10px; padding:16px; border-radius:14px;
      background: linear-gradient(180deg, rgba(10,40,70,.48), rgba(6,24,46,.60));
      border:1px solid var(--line);
      box-shadow: 0 4px 12px rgba(0,0,0,.20), inset 0 0 0 1px #ffffff0d;
      backdrop-filter: blur(6px);
    }
    .info h2{ margin:0 0 8px; font-size:18px; display:flex; align-items:center; gap:10px; }
    .muted{ color:var(--muted); font-size:12px }

    /* Music */
    .transport{ display:flex; align-items:center; gap:10px; margin-top:8px; }
    .tbtn{
      width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px;
      border:1px solid #ffffff22;
      background: linear-gradient(180deg, rgba(10,40,70,.5), rgba(6,24,46,.62));
      color:#fff; cursor:pointer; box-shadow: 0 3px 8px rgba(0,0,0,.2);
    }
    .tbtn:hover{ filter:brightness(1.05) }
    .tbtn:focus-visible{ outline:2px solid var(--focus); outline-offset:3px }
    .songname{ font-weight:800; margin-left:8px; opacity:.95; letter-spacing:.2px }
    .nowchip{
      display:inline-block; padding:3px 8px; border-radius:999px; margin-left:auto;
      font-weight:800; letter-spacing:.2px; color:#0a223b;
      background: #98f0cc; border:1px solid #00000012;
      text-shadow:none;
    }
    .seek{ display:flex; align-items:center; gap:10px; margin-top:8px; }
    .seek input[type="range"]{ width:100% }

    /* ========== Mascots ========== */
    .psec{ margin-top:18px; }
    .phead{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .phead h3{ margin:0; font-size:18px; letter-spacing:.2px }
    .inst{ opacity:.9 }
    .chip{
      margin-left:auto; display:inline-block; padding:4px 10px; border-radius:999px;
      font-weight:800; letter-spacing:.2px; color:#e3f3ff; background: rgba(255,255,255,.06);
      border:1px solid #ffffff1a;
    }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap:12px; margin-top:10px; }
    .tile{
      background: rgba(10,40,70,.5);
      border:1px solid var(--line); border-radius:14px; padding:10px; cursor:pointer; text-align:center;
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
      transition: transform .12s ease, border-color .12s ease;
    }
    .tile img{ width:100%; height:100px; object-fit:contain; display:block; }
    .tname{ margin-top:8px; font-weight:700; color:#eaf2ff; }
    .tile:hover{ transform: translateY(-1px) }
    .tile[aria-selected="true"]{
      outline:2px solid var(--reef);
      box-shadow:none;
      border-color: #2bd9bb;
    }
    .tile:focus-visible{ outline:2px solid var(--focus); outline-offset:3px }

    /* Desktop: force all mascots into a single row (no wrap) */
    @media (min-width: 860px){
      #grid1, #grid2{ grid-auto-flow: column; }
    }
    @media (max-width:640px){
      h1{ font-size:26px }
      .cta-play{ height:52px; padding:0 20px }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Settings</h1>

    <!-- HERO -->
    <div class="hero">
      <a class="cta-play" href="index.html" aria-label="Play Surf Lime">
        <span class="cta-icon" aria-hidden="true">▶</span>
        Play
      </a>
      <div class="cta-hint">Press <strong>Enter</strong> to start</div>
    </div>

    <!-- Two-Player (modern switch) -->
    <div class="bar">
      <div class="toggle" id="twoToggle">
        <span class="label">Two-Player Mode</span>
        <label class="switch" aria-label="Two-Player Mode">
          <input type="checkbox" id="twoP" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- Background Music -->
    <div class="info music-card" id="music">
      <h2>
        <span>Background Music</span>
        <span class="songname" id="songName"></span>
        <span class="nowchip" id="nowChip" hidden>Now playing</span>
      </h2>

      <div class="transport" id="transport">
        <button class="tbtn" id="prevBtn" title="Previous" aria-label="Previous">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line>
          </svg>
        </button>
        <button class="tbtn" id="playBtn" title="Play/Pause" aria-label="Play/Pause">
          <svg id="playIcon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="8 5 19 12 8 19 8 5"></polygon>
          </svg>
        </button>
        <button class="tbtn" id="nextBtn" title="Next" aria-label="Next">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line>
          </svg>
        </button>
      </div>

      <div class="seek">
        <input id="seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
        <div class="muted" id="timeLabel">0:00 / 0:00</div>
      </div>

      <div class="muted">Pick a track; your choice is saved and continues into (and out of) the game.</div>
    </div>

    <!-- Mascots -->
    <section class="psec" id="p1">
      <div class="phead">
        <h3>Player 1</h3>
        <span class="muted inst">Move with ↑/↓, boost with →.</span>
        <span class="chip" id="chip1"></span>
      </div>
      <div class="grid" id="grid1"></div>
    </section>

    <section class="psec" id="p2">
      <div class="phead">
        <h3>Player 2</h3>
        <span class="muted inst">W/S to move, D to boost.</span>
        <span class="chip" id="chip2"></span>
      </div>
      <div class="grid" id="grid2"></div>
    </section>
  </div>

  <!-- config + logic -->
  <script src="config.js"></script>
  <script>
    const IS_MOBILE = (window.matchMedia && matchMedia('(pointer: coarse)').matches) || 'ontouchstart' in window;

    /* === Mascots: alphabetical, Lime first; include Cherry === */
    const OTHER_MASCOTS = ["Banana","Cherry","Grapes","Orange","Pineapple","Strawberry","Watermelon"].sort();
    const ALL_MASCOTS  = ["Lime", ...OTHER_MASCOTS];

    try{ localStorage.setItem('availableMascots', JSON.stringify(ALL_MASCOTS)); }catch(e){}

    if(!localStorage.getItem('selectedMascotP1')) localStorage.setItem('selectedMascotP1','Lime');
    if(!localStorage.getItem('selectedMascot'))  localStorage.setItem('selectedMascot','Lime'); // legacy
    if(!localStorage.getItem('selectedMascotP2')) localStorage.setItem('selectedMascotP2','Banana');

    // Two-player toggle (hidden on mobile)
    const twoP = document.getElementById('twoP');
    const twoToggle = document.getElementById('twoToggle');
    const p2Section = document.getElementById('p2');

    if(IS_MOBILE){
      if(twoToggle) twoToggle.style.display='none';
      localStorage.setItem('twoPlayerEnabled','false');
      if(twoP){ twoP.checked = false; twoP.disabled = true; }
      p2Section.style.display = 'none';
    }else{
      if(twoP){
        twoP.checked = localStorage.getItem('twoPlayerEnabled') === 'true';
        twoP.addEventListener('change', ()=> {
          localStorage.setItem('twoPlayerEnabled', twoP.checked?'true':'false');
          p2Section.style.display = twoP.checked ? '' : 'none';
        });
      }
      p2Section.style.display = (twoP && twoP.checked) ? '' : 'none';
    }

    // Mascot tiles
    const assetsFor = (name)=> window.SURFLIME_CONFIG?.mascot?.assetsFor(name);
    function installMascotFallback(img, name, primary){
      const cands=[];
      const names=[name, (name==='Pineapple'?'Pinapple':null)].filter(Boolean);
      for(const nm of names){ const base=`./Mascots/${nm}/${nm}`; cands.push(`${base}Surfer.png`, `${base}Surf.png`); }
      if(primary && !cands.includes(primary)) cands.unshift(primary);
      let i=0; img.addEventListener('error', ()=>{ if(++i<cands.length) img.src=cands[i]; });
      img.src=cands[0];
    }

    function makeTile(name, playerIndex){
      const t = document.createElement('button');
      t.type='button'; t.className='tile';
      t.setAttribute('data-name', name); t.setAttribute('aria-selected','false');
      const img = document.createElement('img');
      const p = assetsFor?.(name);
      installMascotFallback(img, name, p?.surf);
      img.alt = name;
      const label = document.createElement('div'); label.className='tname'; label.textContent=name;
      t.appendChild(img); t.appendChild(label);
      t.addEventListener('click', () => selectMascot(playerIndex, name));
      return t;
    }

    function selectMascot(idx, name){
      const key = idx===0 ? 'selectedMascotP1' : 'selectedMascotP2';
      localStorage.setItem(key, name);
      if(idx===0) localStorage.setItem('selectedMascot', name); // legacy
      updateSelections();
    }

    function updateSelections(){
      const p1sel = localStorage.getItem('selectedMascotP1') || 'Lime';
      const p2sel = localStorage.getItem('selectedMascotP2') || 'Banana';
      document.getElementById('chip1').textContent = p1sel;
      document.getElementById('chip2').textContent = p2sel;
      document.querySelectorAll('#grid1 .tile').forEach(el=> el.setAttribute('aria-selected', el.dataset.name===p1sel ? 'true' : 'false'));
      document.querySelectorAll('#grid2 .tile').forEach(el=> el.setAttribute('aria-selected', el.dataset.name===p2sel ? 'true' : 'false'));
    }

    const g1 = document.getElementById('grid1'), g2 = document.getElementById('grid2');
    ALL_MASCOTS.forEach(n => { g1.appendChild(makeTile(n,0)); g2.appendChild(makeTile(n,1)); });
    updateSelections();

    // Desktop: one visible row for mascots (no wrapping)
    (function layoutRow(){
      if(!IS_MOBILE){
        const cols = ALL_MASCOTS.length;
        [g1,g2].forEach(g=> g.style.gridTemplateColumns = `repeat(${cols}, minmax(120px,1fr))`);
      }
    })();

    /* === Music transport in Settings (Supabase) with cross-page persistence === */
    (function(){
      const CFG = window.SURFLIME_CONFIG || {};
      const s = CFG.music && CFG.music.supabase;
      const nameEl = document.getElementById('songName');
      const nowChip = document.getElementById('nowChip');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const playBtn = document.getElementById('playBtn');
      const playIcon= document.getElementById('playIcon');
      const seek    = document.getElementById('seek');
      const timeLbl = document.getElementById('timeLabel');

      const K = { url:'musicSelectedUrl', pos:'musicPosition', state:'musicPlayState', changed:'_musicChangedAt' };

      const tracks = (s && s.enabled && s.projectRef && s.bucket && Array.isArray(s.files))
        ? s.files.map(n => ({ name: n, url: `https://${s.projectRef}.supabase.co/storage/v1/object/public/${encodeURIComponent(s.bucket)}/${encodeURIComponent(n)}` }))
        : [];

      const pretty = (file) => (file || '').replace(/\.[^.]+$/,'').replace(/[_-]+/g,' ').trim();
      const fmtT = (sec)=> {
        sec = Math.max(0, Math.floor(sec||0));
        const m = Math.floor(sec/60), s2 = sec%60;
        return m + ':' + String(s2).padStart(2,'0');
      };

      let i = 0;
      if(tracks.length){
        const savedUrl = localStorage.getItem(K.url);
        const found = tracks.findIndex(t => t.url === savedUrl);
        if(found >= 0) i = found;
      }

      let audio = null, playing = false, seekLock=false, saveTimer=0;

      function ensureAudio(){
        if(!audio){
          audio = new Audio();
          audio.loop = true;
          audio.preload = 'auto';
          audio.volume  = 0.6;
          audio.playsInline = true;
          audio.addEventListener('timeupdate', ()=>{
            if(saveTimer++ % 6 === 0){
              try{ localStorage.setItem(K.pos, String(audio.currentTime)); localStorage.setItem(K.changed, String(Date.now())); }catch{}
            }
            if(!seekLock && audio.duration){
              seek.value = Math.round(1000 * (audio.currentTime / audio.duration));
              timeLbl.textContent = fmtT(audio.currentTime) + ' / ' + fmtT(audio.duration);
            }
          });
          audio.addEventListener('play',  ()=>{ playing=true;  setPlayIcon(); nowChip.hidden=false; try{ localStorage.setItem(K.state,'playing'); localStorage.setItem(K.changed, String(Date.now())); }catch{} });
          audio.addEventListener('pause', ()=>{ playing=false; setPlayIcon(); nowChip.hidden=true;  try{ localStorage.setItem(K.state,'paused');  localStorage.setItem(K.changed, String(Date.now())); }catch{} });
          window.addEventListener('beforeunload', ()=>{
            try{
              localStorage.setItem(K.pos, String(audio.currentTime||0));
              localStorage.setItem(K.state, playing ? 'playing' : 'paused');
              localStorage.setItem(K.changed, String(Date.now()));
            }catch{}
          });
        }
        return audio;
      }
      function setPlayIcon(){
        playIcon.innerHTML = playing
          ? '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>'
          : '<polygon points="8 5 19 12 8 19 8 5"></polygon>';
      }
      function show(){
        if(!tracks.length){
          nameEl.textContent = '(no Supabase songs)';
          prevBtn.disabled=nextBtn.disabled=playBtn.disabled=true;
          return;
        }
        nameEl.textContent = pretty(tracks[i].name); // no .wav/.mp3 shown
        try{
          localStorage.setItem(K.url, tracks[i].url);
          localStorage.setItem(K.changed, String(Date.now()));
        }catch{}
      }
      function loadAndMaybeResume(targetUrl){
        const a = ensureAudio();
        const wantUrl = targetUrl || tracks[i].url;
        const savedPos = parseFloat(localStorage.getItem(K.pos) || '0') || 0;
        const wantPlay = (localStorage.getItem(K.state) || '') === 'playing';
        a.src = wantUrl;
        a.onloadedmetadata = ()=>{
          if(Number.isFinite(savedPos) && a.duration && savedPos < a.duration){ a.currentTime = Math.max(0, savedPos); }
          timeLbl.textContent = fmtT(a.currentTime) + ' / ' + fmtT(a.duration);
          if(wantPlay){ a.play().catch(()=>{}); }
        };
      }

      // Controls
      seek.addEventListener('input', ()=>{
        const a = ensureAudio();
        if(!a.duration) return;
        seekLock = true;
        const t = (+seek.value/1000) * a.duration;
        a.currentTime = t;
        timeLbl.textContent = fmtT(a.currentTime) + ' / ' + fmtT(a.duration);
        try{ localStorage.setItem(K.pos, String(a.currentTime)); localStorage.setItem(K.changed, String(Date.now())); }catch{}
        seekLock = false;
      });
      function play(){ if(!tracks.length) return; const a = ensureAudio(); a.src = tracks[i].url; a.play().then(()=>{ playing=true; setPlayIcon(); nowChip.hidden=false; }).catch(()=>{}); }
      function pause(){ if(audio){ audio.pause(); } }
      document.getElementById('prevBtn')?.addEventListener('click', ()=>{ if(!tracks.length) return; i=(i-1+tracks.length)%tracks.length; show(); play(); });
      document.getElementById('nextBtn')?.addEventListener('click', ()=>{ if(!tracks.length) return; i=(i+1)%tracks.length; show(); play(); });
      document.getElementById('playBtn')?.addEventListener('click', ()=>{ if(!tracks.length) return; if(!playing) play(); else pause(); });

      // Initial paint + resume if we were already playing in-game
      show();
      const savedUrl = localStorage.getItem(K.url);
      if(savedUrl){ const idx = tracks.findIndex(t=>t.url===savedUrl); if(idx>=0){ i = idx; show(); } }
      loadAndMaybeResume(savedUrl);

      // Mirror changes triggered by the game page
      window.addEventListener('storage', (e)=>{
        if(e.key === K.url){
          const url = localStorage.getItem(K.url);
          if(url){ const idx = tracks.findIndex(t=>t.url===url); if(idx>=0){ i=idx; show(); loadAndMaybeResume(url); } }
        }
        if(e.key === K.state){
          const st = localStorage.getItem(K.state);
          if(st === 'playing'){ ensureAudio().play().catch(()=>{}); }
          if(st === 'paused'){ pause(); }
        }
        if(e.key === K.pos && audio && !audio.paused){
          const v = parseFloat(localStorage.getItem(K.pos)||'0');
          if(Number.isFinite(v) && audio.duration){ audio.currentTime = Math.min(audio.duration-0.2, Math.max(0,v)); }
        }
      });
    })();

    // Press Enter to Play from Settings
    document.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName) || '';
      if(e.key === 'Enter' && tag !== 'INPUT' && tag !== 'TEXTAREA' && !e.metaKey && !e.ctrlKey){
        window.location.href = 'index.html';
      }
    });

    // done booting -> reveal the page in one go
    requestAnimationFrame(()=> document.documentElement.setAttribute('data-boot','1'));
  </script>
</body>
</html>
